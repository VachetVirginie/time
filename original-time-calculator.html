<!doctype html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calcul d'heures â€” 2025</title>
  <meta name="color-scheme" content="light dark">
  <style>
    /* ==========================
       Design tokens â€” 2025-ready
       ========================== */
    :root {
      /* Light */
      --bg: oklch(98% 0.01 255);
      --fg: oklch(22% 0.02 255);
      --muted: oklch(45% 0.03 255);
      --panel: oklch(100% 0 0 / .6);
      --border: oklch(85% 0.02 255);
      --accent: oklch(60% 0.16 265); /* indigo */
      --accent-ink: oklch(98% 0 0);
      --danger: oklch(60% 0.21 28);  /* red */
      --ok: oklch(60% 0.17 152);     /* green */
      --shadow: 40 20% 20%;
      --radius: 16px;
      --gap: 14px;

      /* Typography */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      --fs-1: clamp(1.2rem, 1rem + 2vw, 2rem);
      --fs-2: clamp(1rem, .9rem + .5vw, 1.125rem);

      /* Motion */
      --easing: cubic-bezier(.2,.8,.2,1);
      --dur: .22s;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: oklch(17% 0.03 260);
        --fg: oklch(95% 0 0);
        --muted: oklch(82% 0.02 260);
        --panel: oklch(24% 0.03 260 / .55);
        --border: oklch(35% 0.02 260);
        --accent: oklch(70% 0.14 265);
        --accent-ink: oklch(12% 0 0);
        --shadow: 220 40% 2%;
      }
    }

    html[data-theme="light"] {
      --bg: oklch(98% 0.01 255);
      --fg: oklch(22% 0.02 255);
      --muted: oklch(45% 0.03 255);
      --panel: oklch(100% 0 0 / .7);
      --border: oklch(85% 0.02 255);
      --accent: oklch(60% 0.16 265);
      --accent-ink: oklch(98% 0 0);
    }
    html[data-theme="dark"] {
      --bg: oklch(17% 0.03 260);
      --fg: oklch(95% 0 0);
      --muted: oklch(82% 0.02 260);
      --panel: oklch(24% 0.03 260 / .55);
      --border: oklch(35% 0.02 260);
      --accent: oklch(70% 0.14 265);
      --accent-ink: oklch(12% 0 0);
    }

    /* Base */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: var(--font); color: var(--fg);
      background:
        radial-gradient(1200px 600px at 20% -10%, oklch(95% 0.02 265 / .6), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, oklch(80% 0.05 250 / .25), transparent 65%),
        linear-gradient(180deg, var(--bg), var(--bg));
      display: grid; place-items: start center; padding: 28px;
    }

    .app {
      width: min(980px, 100%);
      backdrop-filter: saturate(140%) blur(10px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow:
        0 10px 30px hsl(var(--shadow) / .35),
        0 1px 0 var(--border) inset;
      overflow: clip;
      transition: background var(--dur) var(--easing), border-color var(--dur) var(--easing);
    }

    header { padding: 22px 20px; border-bottom: 1px solid var(--border); display: grid; gap: 6px; }
    h1 { margin: 0; font-size: var(--fs-1); letter-spacing: .2px; }
    .lead { margin: 0; color: var(--muted); font-size: var(--fs-2); }

    .toolbar { display: flex; gap: 10px; align-items: center; margin-left: auto; }

    .content { padding: 18px; display: grid; gap: var(--gap); }

    .chip { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: color-mix(in oklab, var(--panel) 70%, transparent); }
    .chip code { font-weight: 700; }

    .rows { display: grid; gap: 12px; }
    .row {
      display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;
      padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: color-mix(in oklab, var(--panel) 80%, transparent);
      transition: border-color var(--dur) var(--easing), background var(--dur) var(--easing);
    }
    @container style(--narrow) {
      .row { grid-template-columns: 1fr; }
    }

    .field { display: grid; gap: 6px; }
    label { font-size: .9rem; color: var(--muted); }
    input[type="time"] {
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--border);
      background: color-mix(in oklab, var(--panel) 70%, transparent);
      color: inherit; font-size: 1rem; accent-color: var(--accent);
      transition: border-color var(--dur) var(--easing), box-shadow var(--dur) var(--easing), background var(--dur) var(--easing);
    }
    input[type="time"]:focus-visible {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 30%, transparent);
    }
    .hint { min-height: 1em; font-size: .9rem; color: var(--muted); }
    .hint.err { color: var(--danger); }

    .btn { appearance: none; border: 1px solid var(--border); border-radius: 12px; padding: 10px 14px; font-weight: 600; cursor: pointer; font-size: .95rem; transition: transform var(--dur) var(--easing),
      background var(--dur) var(--easing), border-color var(--dur) var(--easing), box-shadow var(--dur) var(--easing);}    
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.primary { background: var(--accent); color: var(--accent-ink); border-color: color-mix(in oklab, var(--accent) 70%, var(--border)); }
    .btn.ghost { background: transparent; }
    .btn.danger { background: color-mix(in oklab, var(--danger) 18%, transparent); border-color: color-mix(in oklab, var(--danger) 50%, var(--border)); }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    .result { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; background: color-mix(in oklab, var(--panel) 80%, transparent); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
    .badge { padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); font-weight: 700; }
    .badge.ok { background: color-mix(in oklab, var(--ok) 20%, transparent); }
    .badge.err { background: color-mix(in oklab, var(--danger) 18%, transparent); }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body>
  <main class="app" aria-labelledby="title">
    <header>
      <div style="display:flex; align-items:center; gap: 14px; flex-wrap: wrap;">
        <div>
          <h1 id="title">Calcul d'heures journaliÃ¨res</h1>
          <p class="lead">Saisis tes plages <strong>EntrÃ©e â†’ Sortie</strong>. Les <strong>heures de sortie</strong> dans <code>09:45â€“11:45</code> et <code>14:00â€“16:00</code> sont refusÃ©es.</p>
        </div>
        <div class="toolbar" role="group" aria-label="Affichage">
          <button id="themeToggle" class="btn ghost" type="button" aria-pressed="false" title="Basculer clair/sombre">ðŸŒ“ ThÃ¨me</button>
        </div>
      </div>
    </header>

    <section class="content">
      <div class="chip" aria-hidden="true">Sorties interditesÂ : <code>09:45â€“11:45</code> Â· <code>14:00â€“16:00</code></div>

      <div class="rows" id="rows" aria-live="polite"></div>

      <div class="actions">
        <button class="btn primary" id="addRow">+ Ajouter une plage</button>
        <button class="btn ghost" id="reset">RÃ©initialiser</button>
      </div>

      <div class="result" aria-live="polite">
        <div><strong>Total de la journÃ©e :</strong> <span id="total" class="badge">0h00</span></div>
        <div id="status" class="badge ok" aria-atomic="true">PrÃªt</div>
      </div>
    </section>
  </main>

  <template id="rowTemplate">
    <div class="row">
      <div class="field">
        <label for="start-__i">EntrÃ©e</label>
        <input type="time" inputmode="numeric" id="start-__i" name="start-__i" autocomplete="off" />
        <div class="hint" id="hint-start-__i"></div>
      </div>
      <div class="field">
        <label for="end-__i">Sortie</label>
        <input type="time" inputmode="numeric" id="end-__i" name="end-__i" autocomplete="off" />
        <div class="hint" id="hint-end-__i" aria-live="polite"></div>
      </div>
      <div class="actions" style="justify-content:flex-end">
        <button class="btn ghost" data-action="duplicate" title="Dupliquer la ligne">Dupliquer</button>
        <button class="btn danger" data-action="remove" title="Supprimer la ligne">Supprimer</button>
      </div>
    </div>
  </template>

  <script>
    // ==========================
    // Helpers temporels
    // ==========================
    function toMinutes(hhmm){
      if(!hhmm) return NaN;
      const m = hhmm.match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return NaN;
      const h=+m[1], mi=+m[2];
      if(h>23||mi>59) return NaN;
      return h*60+mi;
    }
    function minsToStr(mins){ const h=Math.floor(mins/60), m=mins%60; return `${h}h${String(m).padStart(2,'0')}`; }
    function minsToHHMM(mins){ const h=Math.floor(mins/60), m=mins%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
    function overlaps(a,b){ return a.start<b.end && b.start<a.end; }

    // CrÃ©neaux d'interdiction de SORTIE uniquement
    const FORBIDDEN=[
      { start: toMinutes('09:45'), end: toMinutes('11:45') },
      { start: toMinutes('14:00'), end: toMinutes('16:00') },
    ];

    // ==========================
    // DOM
    // ==========================
    const rowsEl = document.getElementById('rows');
    const tpl = document.getElementById('rowTemplate');
    const totalEl = document.getElementById('total');
    const statusEl = document.getElementById('status');
    const themeToggle = document.getElementById('themeToggle');

    let rowCount = 0;

    function addRow(values={start:'', end:''}, focusField='start'){
      const frag = tpl.content.cloneNode(true);
      rowCount++;
      const row = frag.querySelector('.row');
      const start = frag.getElementById ? frag.getElementById('start-__i') : frag.querySelector('#start-__i');
      const end = frag.getElementById ? frag.getElementById('end-__i') : frag.querySelector('#end-__i');
      const hStart = frag.querySelector('#hint-start-__i');
      const hEnd = frag.querySelector('#hint-end-__i');

      // IDs uniques
      start.id = `start-${rowCount}`; start.name = start.id;
      end.id = `end-${rowCount}`; end.name = end.id;
      hStart.id = `hint-start-${rowCount}`;
      hEnd.id = `hint-end-${rowCount}`;
      row.dataset.index = String(rowCount);

      start.value = values.start; end.value = values.end;

      start.addEventListener('change', compute);
      end.addEventListener('change', compute);

      row.querySelector('[data-action="duplicate"]').addEventListener('click',()=> addRow({start: start.value, end: end.value}));
      row.querySelector('[data-action="remove"]').addEventListener('click',()=>{ row.remove(); compute();});

      rowsEl.appendChild(frag);
      const focusEl = document.getElementById(`${focusField}-${rowCount}`);
      if(focusEl) focusEl.focus();
      compute();
    }

    function readIntervals(){
      const list=[]; const nodes = rowsEl.querySelectorAll('.row');
      nodes.forEach(node=>{
        const i = node.dataset.index;
        const start = document.getElementById(`start-${i}`);
        const end = document.getElementById(`end-${i}`);
        const s = toMinutes(start.value);
        const e = toMinutes(end.value);
        list.push({node,i,start,end,s,e});
      });
      return list;
    }

    function setHint(el, msg, ok=false){
      const hint = document.getElementById(`hint-${el.id}`);
      if(!hint) return;
      hint.textContent = msg || '';
      hint.classList.toggle('err', !!msg && !ok);
      el.classList.toggle('has-error', !!msg && !ok);
      if(!msg) el.removeAttribute('aria-invalid');
      else el.setAttribute('aria-invalid','true');
    }

    function compute(){
      statusEl.textContent='Calculâ€¦'; statusEl.className='badge';
      totalEl.textContent='0h00';

      let total=0; let hasError=false;
      const items = readIntervals().sort((a,b)=> (a.s||0)-(b.s||0));

      // Nettoie les hints
      items.forEach(({start,end})=>{ setHint(start,'',true); setHint(end,'',true); });

      // Validations
      for(const it of items){
        const {start,end,s,e,i} = it;
        if((start.value && !Number.isFinite(s)) || (end.value && !Number.isFinite(e))){
          setHint(end,'Format HH:MM attendu'); hasError=true; continue;
        }
        if(start.value && end.value){
          if(e<=s){ setHint(end,`La sortie doit Ãªtre aprÃ¨s l'entrÃ©e (${start.value} â†’ ${end.value}).`); hasError=true; continue; }
          // Sortie interdite
          for(const f of FORBIDDEN){
            if(e>f.start && e<f.end){
              setHint(end,`Sortie interdite Ã  ${end.value} (crÃ©neau ${minsToHHMM(f.start)}â€“${minsToHHMM(f.end)}).`);
              hasError=true;
            }
          }
          total += (e-s);
        } else if(start.value || end.value){
          // demi-ligne
          setHint(end,'Renseigne entrÃ©e ET sortie.'); hasError=true;
        }
      }

      if(hasError){ statusEl.textContent='Erreur'; statusEl.className='badge err'; return; }
      statusEl.textContent='OK'; statusEl.className='badge ok';
      totalEl.textContent = minsToStr(total);
    }

    // ThÃ¨me
    (function initTheme(){
      const root = document.documentElement;
      const stored = localStorage.getItem('theme');
      if(stored && (stored==='light' || stored==='dark')) root.setAttribute('data-theme', stored);
      themeToggle.addEventListener('click', ()=>{
        const cur = root.getAttribute('data-theme');
        const next = cur==='dark' ? 'light' : cur==='light' ? 'auto' : 'dark';
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        themeToggle.setAttribute('aria-pressed', next==='dark');
      });
    })();

    // Boot
    document.getElementById('addRow').addEventListener('click',()=> addRow());
    document.getElementById('reset').addEventListener('click',()=>{ rowsEl.innerHTML=''; totalEl.textContent='0h00'; statusEl.textContent='PrÃªt'; statusEl.className='badge ok'; addRow();});
    addRow({start:'08:00', end:'09:30'}, 'end');
    addRow({start:'11:45', end:'13:00'}, 'end');
  </script>
</body>
</html>
